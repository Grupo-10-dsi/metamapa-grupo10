services:

  metamapa_logs:
    image: busybox
    container_name: metamapa_logs
    volumes:
      - metamapa_logs:/var/log/metamapa:ro
    networks:
      - metamapa-net

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: always
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
      - loki
    networks:
      - metamapa-net

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: always
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    networks:
      - metamapa-net

  loki:
    image: grafana/loki:2.8.2
    container_name: loki
    volumes:
      - loki_data:/loki
      - ./monitoring/loki-config.yaml:/etc/loki/local-config.yaml:ro
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - "3100:3100"
    networks:
        - metamapa-net

  promtail:
    image: grafana/promtail:2.8.2
    container_name: promtail
    volumes:
      - ./monitoring/promtail-config.yaml:/etc/promtail/promtail-config.yaml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./logs:/var/log/metamapa
      - ./agregador/logs:/var/log/agregador
      - ./dinamica/logs:/var/log/dinamica
      - ./estadistica/logs:/var/log/estadistica
      - ./estatica/logs:/var/log/estatica
      - ./normalizador/logs:/var/log/normalizador
      - ./gestor-personas/logs:/var/log/gestor-personas
      - ./proxy/logs:/var/log/proxy
      - ./api-gateway/logs:/var/log/api-gateway
    command: -config.file=/etc/promtail/promtail-config.yaml
    depends_on:
      - loki
    networks:
      - metamapa-net

  reverse-proxy:
    image: nginx:alpine
    container_name: reverse-proxy
    volumes:
      - ./reverse-proxy/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./reverse-proxy/certs:/etc/nginx/certs:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - frontend
      - api-gateway
      - keycloak
    networks:
      - metamapa-net

  redis:
    image: redis:alpine
    container_name: redis
    restart: always
    expose:
      - "6379"
    networks:
      - metamapa-net

  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DB_AGREGADOR}
    expose:
      - "3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./readmes/init-databases.sql:/docker-entrypoint-initdb.d/init.sql:ro
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "--silent" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - metamapa-net
  keycloak:
    image: quay.io/keycloak/keycloak:26.4.2
    container_name: keycloak
    command: start --import-realm
    env_file: .env
    environment:
      KC_DB: mysql
      KC_DB_URL_HOST: mysql
      KC_DB_URL_DATABASE: keycloak_db
      KC_DB_USERNAME: ${MYSQL_USER}
      KC_DB_PASSWORD: ${MYSQL_PASSWORD}

      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin

      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME: ${PUBLIC_IP}
      KC_HOSTNAME_STRICT: "false"
      KC_HOSTNAME_STRICT_HTTPS: "false"
      KC_PROXY_HEADERS: xforwarded
      KC_PROXY: edge

      # Habilitar health checks
      KC_HEALTH_ENABLED: "true"
      KC_METRICS_ENABLED: "true"
    volumes:
      - ./keycloak-config:/opt/keycloak/data/import:ro
    expose:
      - "8080"
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
    networks:
      - metamapa-net

  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    restart: always
    env_file: .env
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      ESTADISTICA_URL: ${ESTADISTICA_URL}
      DINAMICA_URL: ${DINAMICA_URL}
      AGREGADOR_URL: ${AGREGADOR_URL}
      KEYCLOAK_URL: ${KEYCLOAK_URL}
      KEYCLOAK_JWK_SET_URI: ${KEYCLOAK_JWK_SET_URI}
      KEYCLOAK_VALID_ISSUERS: ${KEYCLOAK_VALID_ISSUERS}
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
    expose:
      - "8089"
    depends_on:
      keycloak:
        condition: service_started
      agregador:
        condition: service_started
      dinamica:
        condition: service_started
      estadistica:
        condition: service_started
    networks:
      - metamapa-net
    volumes:
      - api_gateway_logs:/var/log/api-gateway

  estatica:
    build: ./estatica
    container_name: estatica
    labels:
      logging: "promtail"
      logging_jobname: "estatica"
    restart: always
    expose:
      - "8081"
    networks:
      - metamapa-net
    volumes:
      - estatica_logs:/var/log/estatica

  dinamica:
    build: ./dinamica
    container_name: dinamica
    restart: always
    env_file: .env
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DB_DINAMICA}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
      SUPABASE_URL: ${SUPABASE_URL}
      SUPABASE_BUCKET: ${SUPABASE_BUCKET}
      SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY}
    depends_on:
      mysql:
        condition: service_healthy
    expose:
      - "8082"
    networks:
      - metamapa-net
    volumes:
      - dinamica_logs:/var/log/dinamica

  proxy:
    build: ./proxy
    container_name: proxy
    restart: always
    environment:
      METAMAPA_INSTANCIA_URL: ${METAMAPA_INSTANCIA_URL}
    depends_on:
      proxyejemplo:
        condition: service_started
    expose:
      - "8083"
    networks:
      - metamapa-net
    volumes:
      - proxy_logs:/var/log/proxy

  proxyejemplo:
    build: ./proxyEjemplo
    container_name: proxyejemplo
    restart: always
    expose:
      - "8084"
    networks:
      - metamapa-net

  normalizador:
    build: ./normalizador
    container_name: normalizador
    restart: always
    expose:
      - "8087"
    networks:
      - metamapa-net
    volumes:
      - normalizador_logs:/var/log/normalizador

  agregador:
    build: ./agregador
    container_name: agregador
    restart: always
    env_file: .env
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DB_AGREGADOR}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    expose:
      - "8080"
    networks:
      - metamapa-net
    volumes:
      - agregador_logs:/var/log/agregador

  estadistica:
    build: ./estadistica
    container_name: estadistica
    restart: always
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DB_ESTADISTICA}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
      AGREGADOR_URL: ${AGREGADOR_URL}
    depends_on:
      mysql:
        condition: service_healthy
      agregador:
        condition: service_started
    expose:
      - "8088"
    networks:
      - metamapa-net
    volumes:
      - estadistica_logs:/var/log/estadistica

  gestor-personas:
    build: ./gestor-personas
    container_name: gestor-personas
    restart: always
    env_file: .env
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://${MYSQL_HOST}:${MYSQL_PORT}/${MYSQL_DB_GESTOR}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&createDatabaseIfNotExist=true
      SPRING_DATASOURCE_USERNAME: ${MYSQL_USER}
      SPRING_DATASOURCE_PASSWORD: ${MYSQL_PASSWORD}
    depends_on:
      mysql:
        condition: service_healthy
    expose:
      - "8086"
    networks:
      - metamapa-net
    volumes:
      - gestor_personas_logs:/var/log/gestor-personas

  frontend:
    build:
      context: ./visualizador
      dockerfile: Dockerfile
      args:
        REACT_APP_API_GATEWAY_URL_BASE: ${REACT_APP_API_GATEWAY_URL_BASE}
        REACT_APP_KEYCLOAK_URL: ${REACT_APP_KEYCLOAK_URL}
        REACT_APP_KEYCLOAK_CLIENT_ID: ${REACT_APP_KEYCLOAK_CLIENT_ID}
        REACT_APP_API_URL: ${REACT_APP_API_URL}
    container_name: frontend
    restart: always
    expose:
      - "80"
    networks:
      - metamapa-net

networks:
  metamapa-net:
    driver: bridge

volumes:
  mysql_data:
  keycloak_data:
  grafana_data:
  metamapa_logs:
  metamapa_loki_data:
  dinamica_logs:
  estadistica_logs:
  estatica_logs:
  normalizador_logs:
  gestor_personas_logs:
  agregador_logs:
  proxy_logs:
  api_gateway_logs:
  loki_data:
    driver: local