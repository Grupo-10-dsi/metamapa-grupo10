spring.application.name=api-gateway
server.port=8089
#logging.level.org.springframework.security=DEBUG
#logging.level.org.springframework.security.oauth2=DEBUG
#logging.level.org.springframework.cloud.gateway.filter.ratelimit=DEBUG
#logging.level.org.springframework.data.redis=DEBUG

visualizador.url=${REACT_APP_API_URL}
agregador.url=${AGREGADOR_URL}
estadistica.url=${ESTADISTICA_URL}
dinamica.url=${DINAMICA_URL}

# --- ConfiguraciÃ³n de CORS Global ---
spring.cloud.gateway.globalcors.add-to-simple-url-handler-mapping=true

# 2. Define la polÃ­tica de CORS
# spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-origins=${REACT_APP_API_URL} -> esto estaba en branch grafana
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-origins=${visualizador.url}
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-methods=GET,POST,PUT,DELETE,OPTIONS
spring.cloud.gateway.globalcors.cors-configurations.[/**].allowed-headers=*
spring.cloud.gateway.globalcors.cors-configurations.[/**].allow-credentials=true

# Rutas agregador
spring.cloud.gateway.routes[0].id=agregador
spring.cloud.gateway.routes[0].uri=${AGREGADOR_URL}
spring.cloud.gateway.routes[0].predicates[0]=Path=/agregador/**
spring.cloud.gateway.routes[0].filters[0].name=RequestRateLimiter
spring.cloud.gateway.routes[0].filters[0].args.key-resolver=#{@ipKeyResolver}
spring.cloud.gateway.routes[0].filters[0].args.redis-rate-limiter.replenishRate=5
spring.cloud.gateway.routes[0].filters[0].args.redis-rate-limiter.burstCapacity=10

# Rutas estadistica
spring.cloud.gateway.routes[1].id=estadisticas
spring.cloud.gateway.routes[1].uri=${ESTADISTICA_URL}
spring.cloud.gateway.routes[1].predicates[0]=Path=/api/estadisticas/**
spring.cloud.gateway.routes[1].filters[0].name=RequestRateLimiter
spring.cloud.gateway.routes[1].filters[0].args.key-resolver=#{@ipKeyResolver}
spring.cloud.gateway.routes[1].filters[0].args.redis-rate-limiter.replenishRate=5
spring.cloud.gateway.routes[1].filters[0].args.redis-rate-limiter.burstCapacity=10

# Rutas dinamica
spring.cloud.gateway.routes[2].id=dinamica
spring.cloud.gateway.routes[2].uri=${DINAMICA_URL}
spring.cloud.gateway.routes[2].predicates[0]=Path=/api/dinamica/**
spring.cloud.gateway.routes[2].filters[0].name=RequestRateLimiter
spring.cloud.gateway.routes[2].filters[0].args.key-resolver=#{@ipKeyResolver}
spring.cloud.gateway.routes[2].filters[0].args.redis-rate-limiter.replenishRate=5
spring.cloud.gateway.routes[2].filters[0].args.redis-rate-limiter.burstCapacity=10


# Seguridad JWT (Keycloak)
spring.security.oauth2.resourceserver.jwt.issuer-uri=${KEYCLOAK_URL}

# Keycloak JWT Configuration
keycloak.url=${KEYCLOAK_URL}
keycloak.jwk-set-uri=${KEYCLOAK_JWK_SET_URI}
keycloak.valid-issuers=${KEYCLOAK_VALID_ISSUERS}


# Configuracion Rate Limiter

spring.data.redis.host=${SPRING_DATA_REDIS_HOST:localhost}
spring.data.redis.port=${SPRING_DATA_REDIS_PORT:6379}

# ReplenishRate define cuÃÂ¡ntas peticiones promedio aceptamos por segundo por usuario
# BurstCapacity define cuantas peticiones se pueden hacer de golpe (en un instante)

# Habilita los endpoints de Actuator para salud y metricas de Prometheus
management.endpoints.web.exposure.include=health,prometheus,info,metrics
management.endpoint.health.enabled=true
management.endpoint.info.enabled=true

management.endpoint.prometheus.enabled=true

# Muestra detalles completos de la salud (opcional, util para debug)
management.endpoint.health.show-details=always

# Agrega una etiqueta con el nombre de la app a todas las mÃ©tricas en Prometheus
# Esto es vital para distinguir que microservicio envio el dato en Grafana
management.metrics.tags.application=${spring.application.name}


logging.file.name=logs/api-gateway.log
logging.level.root=INFO
# Ruta GraphQL directa al agregador
spring.cloud.gateway.routes[3].id=agregador-graphql
spring.cloud.gateway.routes[3].uri=${agregador.url}
spring.cloud.gateway.routes[3].predicates[0]=Path=/graphql

# Ruta GraphiQL UI
spring.cloud.gateway.routes[4].id=agregador-graphiql
spring.cloud.gateway.routes[4].uri=${agregador.url}
spring.cloud.gateway.routes[4].predicates[0]=Path=/graphiql/**

# Configuracion de seguridad para validar tokens JWT emitidos por Keycloak
spring.security.oauth2.resourceserver.jwt.issuer-uri=${keycloak.url}/realms/MetaMapa
